"use strict";(()=>{var a={};a.id=9789,a.ids=[9789],a.modules={261:a=>{a.exports=require("next/dist/shared/lib/router/utils/app-paths")},3295:a=>{a.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:a=>{a.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},19121:a=>{a.exports=require("next/dist/server/app-render/action-async-storage.external.js")},29294:a=>{a.exports=require("next/dist/server/app-render/work-async-storage.external.js")},39840:(a,b,c)=>{c.r(b),c.d(b,{handler:()=>G,patchFetch:()=>F,routeModule:()=>B,serverHooks:()=>E,workAsyncStorage:()=>C,workUnitAsyncStorage:()=>D});var d={};c.r(d),c.d(d,{POST:()=>A});var e=c(95736),f=c(9117),g=c(4044),h=c(39326),i=c(32324),j=c(261),k=c(54290),l=c(85328),m=c(38928),n=c(46595),o=c(3421),p=c(17679),q=c(41681),r=c(63446),s=c(86439),t=c(51356),u=c(10641),v=c(48152),w=c(22074),x=c(42678),y=c(48648),z=c(94649);async function A(a){try{let b=await (0,v.th)();if(!b)return u.NextResponse.json({error:"Authentication required"},{status:401});let c=await a.json(),d=(0,w.i6)(w.Ko,c);if(!d.success)return u.NextResponse.json({error:"Invalid order data",details:d.errors},{status:400});let e=d.data,f=await (0,v.je)(b.id);if(0===f.length)return u.NextResponse.json({error:"Cart is empty"},{status:400});let g=f.filter(a=>a.wine_products.stock_quantity<a.quantity||!a.wine_products.is_active);if(g.length>0)return u.NextResponse.json({error:"Stock issues found",issues:g.map(a=>({product_id:a.product_id,product_name:a.wine_products.name,requested:a.quantity,available:a.wine_products.stock_quantity,is_active:a.wine_products.is_active}))},{status:409});let h=f.map(a=>({product_id:a.product_id,quantity:a.quantity,unit_price:a.wine_products.price})),i=h.reduce((a,b)=>a+b.quantity*b.unit_price,0),j=h.reduce((a,b)=>a+b.quantity,0),k=await (0,z.iM)(e.shippingAddress,j,i),l=k.length>0?k[0].price:0,m=(0,x.SL)({amount:i,shipping_amount:l,country_code:e.shippingAddress.country,customer_type:"consumer"}),n=m.total_amount;if(Math.abs(e.subtotal-i)>10||Math.abs(e.vatAmount-m.vat_amount)>10||Math.abs(e.shippingCost-l)>10||Math.abs(e.totalAmount-n)>10)return u.NextResponse.json({error:"Order total mismatch",calculated:{subtotal:i,vatAmount:m.vat_amount,shippingCost:l,totalAmount:n},provided:{subtotal:e.subtotal,vatAmount:e.vatAmount,shippingCost:e.shippingCost,totalAmount:e.totalAmount}},{status:400});let o=await (0,v.fS)({user_id:b.id,customer_email:e.customerEmail,customer_first_name:e.customerFirstName,customer_last_name:e.customerLastName,shipping_address:e.shippingAddress,billing_address:e.billingAddress,items:h,subtotal:i,vat_amount:m.vat_amount,shipping_cost:l,total_amount:n,payment_method:e.paymentMethod,status:"pending"}),p=null;try{p=(await (0,y.Y_)({orderId:o.id,amount:n,customerEmail:e.customerEmail,customerName:`${e.customerFirstName} ${e.customerLastName}`,description:`Wine order ${o.id.substring(0,8)}`,locale:a.headers.get("accept-language")?.includes("fr")?"fr_FR":"en_US"})).links.checkout}catch(a){return console.error("Payment creation failed:",a),u.NextResponse.json({order:{id:o.id,status:"payment_failed",total_amount:n,currency:"EUR"},error:"Payment processing failed",details:"Please try again or contact support"},{status:402})}try{for(let a of f)await (0,v.dt)(b.id,a.id)}catch(a){console.error("Failed to clear cart:",a)}let q={id:o.id,order_number:o.id.substring(0,8).toUpperCase(),status:o.status,created_at:o.created_at,customer:{email:o.customer_email,first_name:o.customer_first_name,last_name:o.customer_last_name},addresses:{shipping:o.shipping_address,billing:o.billing_address},items:h.map(a=>{let b=f.find(b=>b.product_id===a.product_id)?.wine_products;return{product_id:a.product_id,product_name:b?.name,product_sku:b?.sku,quantity:a.quantity,unit_price:a.unit_price,unit_price_display:(a.unit_price/100).toFixed(2),total_price:a.quantity*a.unit_price,total_price_display:(a.quantity*a.unit_price/100).toFixed(2)}}),totals:{subtotal:i,subtotal_display:(i/100).toFixed(2),vat_amount:m.vat_amount,vat_amount_display:(m.vat_amount/100).toFixed(2),vat_rate:m.vat_rate,vat_rate_display:`${(100*m.vat_rate).toFixed(0)}%`,shipping_cost:l,shipping_cost_display:(l/100).toFixed(2),total_amount:n,total_amount_display:(n/100).toFixed(2),currency:"EUR"},vat_details:{country:m.country,country_code:m.country_code,is_reverse_charge:m.is_reverse_charge,breakdown:m.breakdown},payment:{method:e.paymentMethod,status:"pending",payment_url:p,instructions:p?"Complete your payment using the provided link":"Payment processing failed - please contact support"},next_steps:["Complete payment using the provided link","You will receive an email confirmation","Track your order status in your account","Prepare valid ID for age verification upon delivery"]};return u.NextResponse.json({message:"Order created successfully",order:q},{status:201})}catch(a){if(console.error("Error creating order:",a),a instanceof Error){if(a.message.includes("stock"))return u.NextResponse.json({error:"Insufficient stock for one or more items"},{status:409});if(a.message.includes("payment"))return u.NextResponse.json({error:"Payment processing failed"},{status:402});if(a.message.includes("shipping"))return u.NextResponse.json({error:"Shipping calculation failed"},{status:400});if(a.message.includes("vat"))return u.NextResponse.json({error:"VAT calculation failed"},{status:400})}return u.NextResponse.json({error:"Failed to create order"},{status:500})}}let B=new e.AppRouteRouteModule({definition:{kind:f.RouteKind.APP_ROUTE,page:"/api/orders/route",pathname:"/api/orders",filename:"route",bundlePath:"app/api/orders/route"},distDir:".next",relativeProjectDir:"",resolvedPagePath:"C:\\Users\\olivi\\Domaine Vallot\\src\\app\\api\\orders\\route.ts",nextConfigOutput:"",userland:d}),{workAsyncStorage:C,workUnitAsyncStorage:D,serverHooks:E}=B;function F(){return(0,g.patchFetch)({workAsyncStorage:C,workUnitAsyncStorage:D})}async function G(a,b,c){var d;let e="/api/orders/route";"/index"===e&&(e="/");let g=await B.prepare(a,b,{srcPage:e,multiZoneDraftMode:!1});if(!g)return b.statusCode=400,b.end("Bad Request"),null==c.waitUntil||c.waitUntil.call(c,Promise.resolve()),null;let{buildId:u,params:v,nextConfig:w,isDraftMode:x,prerenderManifest:y,routerServerContext:z,isOnDemandRevalidate:A,revalidateOnlyGenerated:C,resolvedPathname:D}=g,E=(0,j.normalizeAppPath)(e),F=!!(y.dynamicRoutes[E]||y.routes[D]);if(F&&!x){let a=!!y.routes[D],b=y.dynamicRoutes[E];if(b&&!1===b.fallback&&!a)throw new s.NoFallbackError}let G=null;!F||B.isDev||x||(G="/index"===(G=D)?"/":G);let H=!0===B.isDev||!F,I=F&&!H,J=a.method||"GET",K=(0,i.getTracer)(),L=K.getActiveScopeSpan(),M={params:v,prerenderManifest:y,renderOpts:{experimental:{cacheComponents:!!w.experimental.cacheComponents,authInterrupts:!!w.experimental.authInterrupts},supportsDynamicResponse:H,incrementalCache:(0,h.getRequestMeta)(a,"incrementalCache"),cacheLifeProfiles:null==(d=w.experimental)?void 0:d.cacheLife,isRevalidate:I,waitUntil:c.waitUntil,onClose:a=>{b.on("close",a)},onAfterTaskError:void 0,onInstrumentationRequestError:(b,c,d)=>B.onRequestError(a,b,d,z)},sharedContext:{buildId:u}},N=new k.NodeNextRequest(a),O=new k.NodeNextResponse(b),P=l.NextRequestAdapter.fromNodeNextRequest(N,(0,l.signalFromNodeResponse)(b));try{let d=async c=>B.handle(P,M).finally(()=>{if(!c)return;c.setAttributes({"http.status_code":b.statusCode,"next.rsc":!1});let d=K.getRootSpanAttributes();if(!d)return;if(d.get("next.span_type")!==m.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${d.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let e=d.get("next.route");if(e){let a=`${J} ${e}`;c.setAttributes({"next.route":e,"http.route":e,"next.span_name":a}),c.updateName(a)}else c.updateName(`${J} ${a.url}`)}),g=async g=>{var i,j;let k=async({previousCacheEntry:f})=>{try{if(!(0,h.getRequestMeta)(a,"minimalMode")&&A&&C&&!f)return b.statusCode=404,b.setHeader("x-nextjs-cache","REVALIDATED"),b.end("This page could not be found"),null;let e=await d(g);a.fetchMetrics=M.renderOpts.fetchMetrics;let i=M.renderOpts.pendingWaitUntil;i&&c.waitUntil&&(c.waitUntil(i),i=void 0);let j=M.renderOpts.collectedTags;if(!F)return await (0,o.I)(N,O,e,M.renderOpts.pendingWaitUntil),null;{let a=await e.blob(),b=(0,p.toNodeOutgoingHttpHeaders)(e.headers);j&&(b[r.NEXT_CACHE_TAGS_HEADER]=j),!b["content-type"]&&a.type&&(b["content-type"]=a.type);let c=void 0!==M.renderOpts.collectedRevalidate&&!(M.renderOpts.collectedRevalidate>=r.INFINITE_CACHE)&&M.renderOpts.collectedRevalidate,d=void 0===M.renderOpts.collectedExpire||M.renderOpts.collectedExpire>=r.INFINITE_CACHE?void 0:M.renderOpts.collectedExpire;return{value:{kind:t.CachedRouteKind.APP_ROUTE,status:e.status,body:Buffer.from(await a.arrayBuffer()),headers:b},cacheControl:{revalidate:c,expire:d}}}}catch(b){throw(null==f?void 0:f.isStale)&&await B.onRequestError(a,b,{routerKind:"App Router",routePath:e,routeType:"route",revalidateReason:(0,n.c)({isRevalidate:I,isOnDemandRevalidate:A})},z),b}},l=await B.handleResponse({req:a,nextConfig:w,cacheKey:G,routeKind:f.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:y,isRoutePPREnabled:!1,isOnDemandRevalidate:A,revalidateOnlyGenerated:C,responseGenerator:k,waitUntil:c.waitUntil});if(!F)return null;if((null==l||null==(i=l.value)?void 0:i.kind)!==t.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==l||null==(j=l.value)?void 0:j.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});(0,h.getRequestMeta)(a,"minimalMode")||b.setHeader("x-nextjs-cache",A?"REVALIDATED":l.isMiss?"MISS":l.isStale?"STALE":"HIT"),x&&b.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let m=(0,p.fromNodeOutgoingHttpHeaders)(l.value.headers);return(0,h.getRequestMeta)(a,"minimalMode")&&F||m.delete(r.NEXT_CACHE_TAGS_HEADER),!l.cacheControl||b.getHeader("Cache-Control")||m.get("Cache-Control")||m.set("Cache-Control",(0,q.getCacheControlHeader)(l.cacheControl)),await (0,o.I)(N,O,new Response(l.value.body,{headers:m,status:l.value.status||200})),null};L?await g(L):await K.withPropagatedContext(a.headers,()=>K.trace(m.BaseServerSpan.handleRequest,{spanName:`${J} ${a.url}`,kind:i.SpanKind.SERVER,attributes:{"http.method":J,"http.target":a.url}},g))}catch(b){if(b instanceof s.NoFallbackError||await B.onRequestError(a,b,{routerKind:"App Router",routePath:E,routeType:"route",revalidateReason:(0,n.c)({isRevalidate:I,isOnDemandRevalidate:A})}),F)throw b;return await (0,o.I)(N,O,new Response(null,{status:500})),null}}},42678:(a,b,c)=>{c.d(b,{SL:()=>g});let d={AT:{country_code:"AT",country_name:"Austria",rate:.2,is_eu_member:!0,is_active:!0},BE:{country_code:"BE",country_name:"Belgium",rate:.21,is_eu_member:!0,is_active:!0},BG:{country_code:"BG",country_name:"Bulgaria",rate:.2,is_eu_member:!0,is_active:!0},HR:{country_code:"HR",country_name:"Croatia",rate:.25,is_eu_member:!0,is_active:!0},CY:{country_code:"CY",country_name:"Cyprus",rate:.19,is_eu_member:!0,is_active:!0},CZ:{country_code:"CZ",country_name:"Czech Republic",rate:.21,is_eu_member:!0,is_active:!0},DK:{country_code:"DK",country_name:"Denmark",rate:.25,is_eu_member:!0,is_active:!0},EE:{country_code:"EE",country_name:"Estonia",rate:.2,is_eu_member:!0,is_active:!0},FI:{country_code:"FI",country_name:"Finland",rate:.24,is_eu_member:!0,is_active:!0},FR:{country_code:"FR",country_name:"France",rate:.2,is_eu_member:!0,is_active:!0},DE:{country_code:"DE",country_name:"Germany",rate:.19,is_eu_member:!0,is_active:!0},GR:{country_code:"GR",country_name:"Greece",rate:.24,is_eu_member:!0,is_active:!0},HU:{country_code:"HU",country_name:"Hungary",rate:.27,is_eu_member:!0,is_active:!0},IE:{country_code:"IE",country_name:"Ireland",rate:.23,is_eu_member:!0,is_active:!0},IT:{country_code:"IT",country_name:"Italy",rate:.22,is_eu_member:!0,is_active:!0},LV:{country_code:"LV",country_name:"Latvia",rate:.21,is_eu_member:!0,is_active:!0},LT:{country_code:"LT",country_name:"Lithuania",rate:.21,is_eu_member:!0,is_active:!0},LU:{country_code:"LU",country_name:"Luxembourg",rate:.17,is_eu_member:!0,is_active:!0},MT:{country_code:"MT",country_name:"Malta",rate:.18,is_eu_member:!0,is_active:!0},NL:{country_code:"NL",country_name:"Netherlands",rate:.21,is_eu_member:!0,is_active:!0},PL:{country_code:"PL",country_name:"Poland",rate:.23,is_eu_member:!0,is_active:!0},PT:{country_code:"PT",country_name:"Portugal",rate:.23,is_eu_member:!0,is_active:!0},RO:{country_code:"RO",country_name:"Romania",rate:.19,is_eu_member:!0,is_active:!0},SK:{country_code:"SK",country_name:"Slovakia",rate:.2,is_eu_member:!0,is_active:!0},SI:{country_code:"SI",country_name:"Slovenia",rate:.22,is_eu_member:!0,is_active:!0},ES:{country_code:"ES",country_name:"Spain",rate:.21,is_eu_member:!0,is_active:!0},SE:{country_code:"SE",country_name:"Sweden",rate:.25,is_eu_member:!0,is_active:!0}};class e{constructor(a){this.vatRates=a||d}calculateVat(a){let{amount:b,shipping_amount:c=0,country_code:d,product_type:e="wine",customer_type:f="consumer",business_vat_number:g}=a,h=d.toUpperCase(),i=this.getVatRate(h),j=this.shouldApplyReverseCharge(h,f,g),k=j?0:i?.rate||0,l=Math.round(b*k),m=Math.round(c*k),n=l+m;return{base_amount:b,shipping_amount:c,vat_rate:k,vat_amount:n,total_amount:b+c+n,country:i?.country_name||"Unknown",country_code:h,is_reverse_charge:j,breakdown:{product_vat:l,shipping_vat:m},exemption_reason:j?"Reverse charge - B2B transaction":i?.is_eu_member?void 0:"Non-EU country"}}getVatRate(a){return this.vatRates[a]||null}shouldApplyReverseCharge(a,b,c){if("business"!==b||!c||!this.isValidVatNumber(c))return!1;let d=this.getVatRate(a);return!!d?.is_eu_member&&"FR"!==a}isValidVatNumber(a){let b=a.replace(/\s/g,"").toUpperCase();return/^[A-Z]{2}[A-Z0-9]{2,12}$/.test(b)}calculateVatForItems(a,b){let c=a.reduce((a,b)=>a+b.amount,0);return this.calculateVat({...b,amount:c})}getAllVatRates(){return Object.values(this.vatRates).filter(a=>a.is_active)}getEuCountries(){return this.getAllVatRates().filter(a=>a.is_eu_member)}isEuCountry(a){let b=this.getVatRate(a.toUpperCase());return b?.is_eu_member||!1}formatVatAmount(a,b="EUR"){return new Intl.NumberFormat("fr-FR",{style:"currency",currency:b}).format(a/100)}formatVatRate(a){return`${(100*a).toFixed(0)}%`}}let f=new e,g=a=>f.calculateVat(a)},44870:a=>{a.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},63033:a=>{a.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},86439:a=>{a.exports=require("next/dist/shared/lib/no-fallback-error.external")},93939:a=>{a.exports=require("@supabase/supabase-js")}};var b=require("../../../webpack-runtime.js");b.C(a);var c=b.X(0,[4586,6802,1692,4410,2995,4853,1362],()=>b(b.s=39840));module.exports=c})();